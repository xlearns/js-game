<html>
  <head>
    <meta charset="UTF-8" />
    <title>dnf</title>
    <style>
      .main {
        display: flex;
      }
      .right {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      .right button {
        border: none;
        padding: 15px;
        background-color: #00bcd4;
        color: white;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="main">
      <canvas id="gka" width="800" height="480"></canvas>
      <div class="right">
        <button onclick="fn('static')">城镇待机</button>
        <button onclick="fn('idle')">战斗待机</button>
        <button onclick="fn('walk')">行走</button>
        <button onclick="fn('run')">奔跑</button>
        <button onclick="fn('attack1')">普通1</button>
        <button onclick="fn('attack2')">普通2</button>
        <button onclick="fn('attack3')">普通3</button>
        <button onclick="fn('frontThornAttack')">前突刺</button>
        <button onclick="fn('pickUp')">上调</button>
        <button onclick="fn('ghost')">鬼斩</button>
      </div>
    </div>
    <script src="./gka-data.js"></script>
    <script src="./json.js"></script>
    <script src="config.js"></script>
    <script>
      let status = "static";
      let [start, end] = action[status];
      let i = start;
      function fn(type) {
        status = type;
        [start, end] = action[status];
        i = start;
      }
      function preloadImage(names, cb, prefix) {
        window.gkaCache = window.gkaCache || [];
        var n = 0,
          img,
          imgs = {};
        names.forEach(function (name) {
          img = new Image();
          window.gkaCache.push(img);
          img.onload = (function (name, img) {
            return function () {
              imgs[name] = img;
              ++n === names.length && cb && cb(imgs);
            };
          })(name, img);
          img.src = (prefix || "") + name;
        });
      }

      function drawBg(ctx, width, height) {
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, width, height);
      }

      function update(o, ctxCache, imgs) {
        t = data.frames[o[0]];
        ctxCache.save();
        ctxCache.translate(json[o[0]][0], json[o[0]][1]);
        ctxCache.drawImage(
          imgs[t.file] || imgs[data.file],
          t.x || data.x || 0,
          t.y || data.y || 0,
          t.width || data.width,
          t.height || data.height,
          t.offX || data.offX || 0,
          t.offY || data.offY || 0,
          t.width || data.width,
          t.height || data.height
        );
        ctxCache.restore();
      }
      preloadImage(
        ["sprites.png"],
        function (imgs) {
          var canvas = document.getElementById("gka"),
            ctx = canvas.getContext("2d"),
            frames = data.frames,
            o = {},
            key = Object.keys(data.animations)[0],
            list = data.animations[key],
            len = list.length,
            width = data.w,
            height = data.h,
            ratio = Math.max(document.body.clientWidth / 375, 1);
          drawBg(ctx, width, height);

          var cacheCanvas = document.createElement("canvas"),
            ctxCache = cacheCanvas.getContext("2d");

          cacheCanvas.width = canvas.width;
          cacheCanvas.height = canvas.height;

          setInterval(function () {
            console.log(status);
            o = list[i];
            drawBg(ctxCache, canvas.width, canvas.height);
            o = Object.prototype.toString.call(o) == "[object Array]" ? o : [o];
            update(o, ctxCache, imgs);
            ctx.drawImage(cacheCanvas, 0, 0, canvas.width, canvas.height);
            i = ++i === end ? start : i;
          }, (1000 / 60) * 10);
        },
        "img/"
      );
    </script>
  </body>
</html>
